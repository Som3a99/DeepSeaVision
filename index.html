<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrashCan 1.0 Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
        #imageContainer img {
            max-width: 100%;
            height: auto;
        }
        #engineOn > * {
            margin-bottom: 1rem;
        }
        .bg-white-10 {
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden bg-gray-900">
    <!-- Background Video -->
    <video autoplay loop muted class="fixed top-0 left-0 w-full h-full object-cover z-0">
        <source src="/static/ocean_background.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="bg-white-10 backdrop-blur-md rounded-xl shadow-xl overflow-y-auto max-h-[90vh] w-full max-w-md z-10 relative">
        <div class="p-6 space-y-6">
            <h1 class="text-3xl font-bold text-center text-white">TrashCan 1.0 Detector</h1>
            
            <div id="engineOff">
                <button id="startEngine" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">
                    Start Engine
                </button>
            </div>

            <div id="engineOn" class="hidden space-y-4">
                <label for="fileInput" class="sr-only">Upload Photo</label>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <button id="uploadPhoto" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">
                    Upload Photo
                </button>
                <button id="openCamera" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">
                    Open Camera
                </button>
                <button id="startLiveStream" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded">
                    Live Stream
                </button>
                <div id="cameraContainer" class="hidden space-y-4">
                    <video id="video" autoplay playsinline class="w-full rounded-lg"></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <div class="flex justify-between">
                        <button id="capturePhoto" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">
                            Capture
                        </button>
                        <button id="closeCamera" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded">
                            Close Camera
                        </button>
                    </div>
                </div>
                <div id="imageContainer" class="hidden space-y-4">
                    <img id="capturedImage" class="w-full rounded-lg" alt="Captured Image">
                    <button id="tryAgain" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded">
                        Try Again
                    </button>
                </div>
                <div id="resultContainer" class="hidden mt-4 p-4 bg-white/20 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-2">Detection Result:</h2>
                    <p id="detectionResult" class="text-white"></p>
                </div>
                <button id="turnOffEngine" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded">
                    Turn Off Engine
                </button>
            </div>
        </div>
    </div>

    <!-- Animated background elements -->
    <div class="fixed inset-0 pointer-events-none z-20">
        <div class="absolute top-1/4 left-1/4 w-12 h-12 bg-white rounded-full opacity-10 animate-float"></div>
        <div class="absolute top-3/4 right-1/4 w-8 h-8 bg-white rounded-full opacity-10 animate-float animation-delay-2000"></div>
        <div class="absolute bottom-1/4 left-1/2 w-10 h-10 bg-white rounded-full opacity-10 animate-float animation-delay-4000"></div>
    </div>

    <!-- Audio elements for sound effects -->
    <audio id="startupSound" src="/static/startup-sound.mp3"></audio>
    <audio id="shutdownSound" src="/static/shutdown-sound.mp3"></audio>

    <script>
        let isEngineOn = false;
        let isCameraOpen = false;
        let isLiveStream = false;
        let stream = null;

        const startEngine = document.getElementById('startEngine');
        const engineOff = document.getElementById('engineOff');
        const engineOn = document.getElementById('engineOn');
        const uploadPhoto = document.getElementById('uploadPhoto');
        const fileInput = document.getElementById('fileInput');
        const openCamera = document.getElementById('openCamera');
        const startLiveStream = document.getElementById('startLiveStream');
        const cameraContainer = document.getElementById('cameraContainer');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturePhoto = document.getElementById('capturePhoto');
        const closeCamera = document.getElementById('closeCamera');
        const imageContainer = document.getElementById('imageContainer');
        const capturedImage = document.getElementById('capturedImage');
        const tryAgain = document.getElementById('tryAgain');
        const resultContainer = document.getElementById('resultContainer');
        const detectionResult = document.getElementById('detectionResult');
        const turnOffEngine = document.getElementById('turnOffEngine');
        const startupSound = document.getElementById('startupSound');
        const shutdownSound = document.getElementById('shutdownSound');

        startEngine.addEventListener('click', () => {
            isEngineOn = true;
            engineOff.classList.add('hidden');
            engineOn.classList.remove('hidden');
            startupSound.play();
        });

        uploadPhoto.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showResult(data.image, data.predictions);
            }
        });

        openCamera.addEventListener('click', () => {
            isCameraOpen = true;
            isLiveStream = false;
            startCamera();
        });

        startLiveStream.addEventListener('click', () => {
            isCameraOpen = true;
            isLiveStream = true;
            startCamera();
        });

        capturePhoto.addEventListener('click', async () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
            const formData = new FormData();
            formData.append('file', blob, 'capture.jpg');
            const response = await fetch('/predict', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            showResult(data.image, data.predictions);
        });

        closeCamera.addEventListener('click', () => {
            stopCamera();
            cameraContainer.classList.add('hidden');
        });

        tryAgain.addEventListener('click', () => {
            stopCamera();
            imageContainer.classList.add('hidden');
            resultContainer.classList.add('hidden');
            cameraContainer.classList.add('hidden');
        });

        turnOffEngine.addEventListener('click', () => {
            isEngineOn = false;
            stopCamera();
            engineOn.classList.add('hidden');
            engineOff.classList.remove('hidden');
            shutdownSound.play();
        });

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(str => {
                    stream = str;
                    video.srcObject = stream;
                    cameraContainer.classList.remove('hidden');
                    imageContainer.classList.add('hidden');
                    resultContainer.classList.add('hidden');
                    if (isLiveStream) {
                        capturePhoto.classList.add('hidden');
                        startLiveDetection();
                    } else {
                        capturePhoto.classList.remove('hidden');
                    }
                })
                .catch(err => console.error("Error accessing the camera", err));
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            video.pause();
            cameraContainer.classList.add('hidden');
            isCameraOpen = false;
            isLiveStream = false;
        }

        function showResult(imageBase64, predictions) {
            capturedImage.src = `data:image/jpeg;base64,${imageBase64}`;
            imageContainer.classList.remove('hidden');
            resultContainer.classList.remove('hidden');
            detectionResult.textContent = predictions.map(p => `${p.class_name}: ${p.confidence.toFixed(2)}`).join(', ');
    
            // Smooth scroll to the bottom of the container
            const container = document.querySelector('.bg-white-10');
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }

        async function startLiveDetection() {
            while (isLiveStream) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
                const formData = new FormData();
                formData.append('file', blob, 'live.jpg');
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                showResult(data.image, data.predictions);
                await new Promise(resolve => setTimeout(resolve, 100)); // Adjust delay as needed
            }
        }
    </script>
</body>
</html>